<div class="recibos-container">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1>Gestión de Recibos</h1>
          <p class="text-muted">Administra los recibos y pagos de los alumnos</p>
        </div>
        <button class="btn btn-primary" (click)="nuevoRecibo()" *ngIf="!mostrarFormulario && !cargando">
          <i class="bi bi-receipt me-2"></i>
          Nuevo Recibo
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="cargando" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Cargando recibos...</p>
  </div>

  <div *ngIf="errorCarga && !cargando" class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ errorCarga }}
  </div>

  <div class="row mb-4" *ngIf="mostrarFormulario && !cargando">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">{{editando ? 'Editar Recibo' : 'Nuevo Recibo'}}</h5>
          <button class="btn btn-sm btn-outline-secondary" (click)="cancelarEdicion()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="card-body">
          <form [formGroup]="reciboForm" (ngSubmit)="guardarRecibo()">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Alumno *</label>
                <select class="form-select" formControlName="id_alumno" (change)="onAlumnoChange()">
                  <option value="">Seleccionar alumno</option>
                  <option *ngFor="let alumno of alumnos" [value]="alumno.id_alumno">
                    {{alumno.nombre}} {{alumno.apellidos}} ({{alumno.cuota_mensual}}€)
                  </option>
                </select>
                <div class="text-danger small" *ngIf="reciboForm.get('id_alumno')?.invalid && reciboForm.get('id_alumno')?.touched">
                  Debe seleccionar un alumno
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Mes *</label>
                <select class="form-select" formControlName="mes">
                  <option value="">Seleccionar mes</option>
                  <option *ngFor="let mes of getMesesCompletos()" [value]="mes">{{mes}}</option>
                </select>
                <div class="text-danger small" *ngIf="reciboForm.get('mes')?.invalid && reciboForm.get('mes')?.touched">
                  Debe seleccionar un mes
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Importe (€) *</label>
                <input type="number" class="form-control" formControlName="importe" min="0" step="0.01">
                <div class="text-danger small" *ngIf="reciboForm.get('importe')?.invalid && reciboForm.get('importe')?.touched">
                  Importe requerido (mínimo 0€)
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Estado *</label>
                <select class="form-select" formControlName="estado">
                  <option *ngFor="let estado of estados" [value]="estado">{{estado}}</option>
                </select>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary" [disabled]="reciboForm.invalid">
                <i class="bi" [class.bi-save]="!editando" [class.bi-check]="editando"></i>
                {{editando ? 'Actualizar' : 'Guardar'}}
              </button>
              <button type="button" class="btn btn-secondary" (click)="cancelarEdicion()">
                <i class="bi bi-x-circle"></i>
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4" *ngIf="!cargando && !mostrarFormulario">
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5 class="card-title">Total Recibos</h5>
          <p class="card-text display-6">{{totalRecibos}}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5 class="card-title">Recibos Pagados</h5>
          <p class="card-text display-6">{{recibosPagados}}</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h5 class="card-title">Ingresos Totales</h5>
          <p class="card-text display-6">{{ingresosTotales}}€</p>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h5 class="card-title">Pendiente de Cobro</h5>
          <p class="card-text display-6">{{pendienteCobro}}€</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-3" *ngIf="!cargando && !mostrarFormulario">
    <div class="col-12">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#todos">Todos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#pendientes">
            Pendientes <span class="badge bg-warning">{{getRecibosPorEstado('PENDIENTE').length}}</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#pagados">
            Pagados <span class="badge bg-success">{{getRecibosPorEstado('PAGADO').length}}</span>
          </a>
        </li>
      </ul>
    </div>
  </div>

  <div class="tab-content" *ngIf="!cargando && !mostrarFormulario">
    <div class="tab-pane fade show active" id="todos">
      <div class="card shadow">
        <div class="card-header bg-white">
          <h5 class="mb-0">Todos los Recibos</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Alumno</th>
                  <th>Mes</th>
                  <th>Importe</th>
                  <th>Estado</th>
                  <th>Fecha Emisión</th>
                  <th>Fecha Pago</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let recibo of recibos">
                  <td>
                    <strong>{{recibo.alumno_nombre || getNombreAlumno(recibo.id_alumno)}}</strong>
                  </td>
                  <td>{{recibo.mes}}</td>
                  <td>
                    <strong>{{recibo.importe}}€</strong>
                  </td>
                  <td>
                    <span class="badge" [class.bg-success]="recibo.estado === 'PAGADO'" [class.bg-warning]="recibo.estado === 'PENDIENTE'">
                      {{recibo.estado}}
                    </span>
                  </td>
                  <td>
                    <small class="text-muted">{{recibo.fecha_emision}}</small>
                  </td>
                  <td>
                    <small class="text-muted">{{recibo.fecha_pago || '--'}}</small>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" (click)="editarRecibo(recibo)" title="Editar">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button 
                        *ngIf="recibo.estado === 'PENDIENTE'"
                        class="btn btn-outline-success" 
                        (click)="marcarComoPagado(recibo)"
                        title="Marcar como pagado">
                        <i class="bi bi-check-lg"></i>
                      </button>
                      <button class="btn btn-outline-danger" (click)="eliminarRecibo(recibo.id_recibo)" title="Eliminar">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div *ngIf="recibos.length === 0 && !errorCarga" class="text-center py-4">
            <i class="bi bi-receipt display-1 text-muted"></i>
            <p class="text-muted mt-3">No hay recibos registrados</p>
            <button class="btn btn-primary" (click)="nuevoRecibo()">
              <i class="bi bi-receipt me-2"></i>
              Crear Primer Recibo
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="pendientes">
      <div class="card shadow">
        <div class="card-header bg-white">
          <h5 class="mb-0">Recibos Pendientes</h5>
        </div>
        <div class="card-body">
          <div *ngIf="getRecibosPorEstado('PENDIENTE').length === 0" class="text-center py-4">
            <i class="bi bi-check-circle display-1 text-success"></i>
            <p class="text-success mt-3">¡Todos los recibos están pagados!</p>
          </div>
          
          <div *ngFor="let recibo of getRecibosPorEstado('PENDIENTE')" class="card mb-2">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-3">
                  <strong>{{recibo.alumno_nombre || getNombreAlumno(recibo.id_alumno)}}</strong>
                </div>
                <div class="col-md-2">
                  {{recibo.mes}}
                </div>
                <div class="col-md-2">
                  <strong class="text-warning">{{recibo.importe}}€</strong>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Emitido: {{recibo.fecha_emision}}</small>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-success btn-sm" (click)="marcarComoPagado(recibo)">
                    <i class="bi bi-check-lg me-1"></i> Marcar Pagado
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="pagados">
      <div class="card shadow">
        <div class="card-header bg-white">
          <h5 class="mb-0">Recibos Pagados</h5>
        </div>
        <div class="card-body">
          <div *ngIf="getRecibosPorEstado('PAGADO').length === 0" class="text-center py-4">
            <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
            <p class="text-warning mt-3">No hay recibos pagados todavía</p>
          </div>
          
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Alumno</th>
                  <th>Mes</th>
                  <th>Importe</th>
                  <th>Fecha Pago</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let recibo of getRecibosPorEstado('PAGADO')">
                  <td>{{recibo.alumno_nombre || getNombreAlumno(recibo.id_alumno)}}</td>
                  <td>{{recibo.mes}}</td>
                  <td class="text-success">{{recibo.importe}}€</td>
                  <td><small class="text-muted">{{recibo.fecha_pago}}</small></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>